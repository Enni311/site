<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless P2P Messenger</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê –ò –°–¢–ò–õ–ò */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        #loginScreen { position: absolute; top:0; left:0; width:100%; height:100%; background: #1e1e1e; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .panel { background: #2c2c2c; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; width: 300px; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; background: #3a3a3a; border: 1px solid #555; color: white; border-radius: 5px; box-sizing: border-box;}
        button { width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; margin-top: 5px;}
        button:hover { background: #0056b3; }
        button.secondary { background: #444; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */
        .mic-meter-container { width: 100%; height: 6px; background: #444; border-radius: 3px; overflow: hidden; margin: 10px 0; }
        .mic-meter { height: 100%; width: 0%; background: #0f0; transition: width 0.1s; }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #app { display: none; width: 100%; height: 100%; display: flex; }
        .sidebar { width: 300px; background: #1a1a1a; border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #121212; position: relative;}
        
        /* –í–∏–¥–µ–æ –∑–æ–Ω–∞ */
        .video-container { height: 250px; background: #000; display: flex; justify-content: center; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #333; }
        video { height: 100%; border-radius: 8px; background: #222; border: 1px solid #444; }
        .controls { display: flex; gap: 10px; justify-content: center; padding: 10px; background: #1a1a1a; }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { display: flex; align-items: flex-start; max-width: 70%; }
        .msg img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; background: #333; }
        .msg-content { background: #2c2c2c; padding: 10px; border-radius: 8px; }
        .msg.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg.mine img { margin-right: 0; margin-left: 10px; }
        .msg.mine .msg-content { background: #005cbf; }
        
        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .input-box { padding: 15px; background: #1a1a1a; display: flex; gap: 10px; }
        
        /* –°—Ç–∞—Ç—É—Å—ã */
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-bottom: 10px; }
        .status-wait { background: #ff9800; color: black; }
        .status-ok { background: #28a745; color: white; }

        h3 { margin-top: 0; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="panel">
            <h2>üöÄ P2P Messenger</h2>
            <input type="text" id="nickname" placeholder="–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º">
            
            <hr style="border-color: #444; margin: 15px 0;">
            
            <label style="font-size: 12px; color: #aaa;">–í—ã–±–µ—Ä–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω:</label>
            <select id="micSelect"></select>
            
            <button class="secondary" onclick="testMicrophone()">üéôÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
            <div class="mic-meter-container">
                <div id="micLevel" class="mic-meter"></div>
            </div>
            <div id="micStatus" style="font-size: 11px; color: #888; height: 15px;"></div>

            <button onclick="enterApp()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
        </div>
    </div>

    <div id="app" style="display: none;">
        <div class="sidebar">
            <div style="text-align: center; margin-bottom: 20px;">
                <img id="myAvatar" width="80" style="border-radius: 50%; background: #333;">
                <h3 id="myNickDisplay">...</h3>
                <p style="font-size: 12px; color: #888;">–¢–≤–æ–π —Å—Ç–∞—Ç—É—Å: <span style="color:lime">–û–Ω–ª–∞–π–Ω</span></p>
            </div>

            <div style="background: #252525; padding: 10px; border-radius: 5px;">
                <label style="font-size: 12px; color: #aaa;">–¢–≤–æ–π ID (–æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É):</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="myId" readonly style="font-size: 12px;">
                    <button onclick="copyId()" style="width: 60px; padding: 5px;">Copy</button>
                </div>
            </div>

            <br>
            <div style="background: #252525; padding: 10px; border-radius: 5px;">
                <label style="font-size: 12px; color: #aaa;">ID –¥—Ä—É–≥–∞:</label>
                <input type="text" id="remoteId" placeholder="–í—Å—Ç–∞–≤—å ID —Å—é–¥–∞">
                <button onclick="connectToPeer()" id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
            
            <div id="connectionStatus" class="status-badge status-wait" style="margin-top: 20px; display:none;">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        </div>

        <div class="chat-area">
            <div class="video-container">
                <video id="localVideo" muted autoplay playsinline></video>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
            
            <div class="controls">
                <button class="secondary" onclick="toggleMic()" id="btnMic">üé§ –í—ã–∫–ª –ú–∏–∫—Ä–æ</button>
                <button class="secondary" onclick="toggleCam()" id="btnCam">üì∑ –í—ã–∫–ª –ö–∞–º–µ—Ä—É</button>
                <button class="secondary" onclick="shareScreen()">üñ•Ô∏è –î–µ–º–∫–∞ —ç–∫—Ä–∞–Ω–∞</button>
                <button style="background: #dc3545;" onclick="endCall()">üìû –°–±—Ä–æ—Å</button>
            </div>

            <div class="messages" id="chatBox">
                <div style="text-align: center; color: #555; font-size: 12px;">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—á–∏—Å—Ç–∏—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)</div>
            </div>
            
            <div class="input-box">
                <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button style="width: 80px;" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let peer;
        let conn; // –î–ª—è —á–∞—Ç–∞ (–¥–∞–Ω–Ω—ã–µ)
        let currentCall; // –î–ª—è –∑–≤–æ–Ω–∫–∞ (–º–µ–¥–∏–∞)
        let localStream;
        let myNick = "";
        let myAvatarUrl = "";
        
        const micSelect = document.getElementById('micSelect');
        const micLevel = document.getElementById('micLevel');
        
        // --- 1. –ù–ê–°–¢–†–û–ô–ö–ê –î–ï–í–ê–ô–°–û–í ---
        async function getDevices() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true }); // –ó–∞–ø—Ä–æ—Å –ø—Ä–∞–≤ —Å—Ä–∞–∑—É
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(d => d.kind === 'audioinput');
                micSelect.innerHTML = '';
                audioInputs.forEach(device => {
                    const opt = document.createElement('option');
                    opt.value = device.deviceId;
                    opt.text = device.label || '–ú–∏–∫—Ä–æ—Ñ–æ–Ω ' + (micSelect.length + 1);
                    micSelect.appendChild(opt);
                });
            } catch (e) {
                console.error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–µ–≤–∞–π—Å–∞–º", e);
            }
        }
        getDevices();

        function testMicrophone() {
            const constraints = { audio: { deviceId: micSelect.value ? { exact: micSelect.value } : undefined } };
            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                document.getElementById('micStatus').innerText = "–ì–æ–≤–æ—Ä–∏—Ç–µ! (–≠—Ö–æ –≤–∫–ª –Ω–∞ 3 —Å–µ–∫)";
                
                // –≠—Ö–æ —Ç–µ—Å—Ç
                const audio = new Audio();
                audio.srcObject = stream;
                audio.play();

                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
                
                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                let testRunning = true;
                scriptProcessor.onaudioprocess = function() {
                    if(!testRunning) return;
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    let values = 0;
                    for (let i = 0; i < array.length; i++) values += array[i];
                    const average = values / array.length;
                    micLevel.style.width = Math.min(100, average * 2) + '%';
                };

                setTimeout(() => {
                    testRunning = false;
                    stream.getTracks().forEach(t => t.stop());
                    document.getElementById('micStatus').innerText = "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.";
                    micLevel.style.width = '0%';
                    audio.pause();
                }, 3000);
            });
        }

        // --- 2. –í–•–û–î –í –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
        function enterApp() {
            myNick = document.getElementById('nickname').value;
            if(!myNick) return alert("–í–≤–µ–¥–∏ –Ω–∏–∫!");

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏
            myAvatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${myNick}`;
            document.getElementById('myAvatar').src = myAvatarUrl;
            document.getElementById('myNickDisplay').innerText = myNick;

            initPeer();
            startLocalVideo();
        }

        // –ó–∞–ø—É—Å–∫ —Å–≤–æ–µ–π –∫–∞–º–µ—Ä—ã/–º–∏–∫—Ä–æ
        function startLocalVideo() {
            const constraints = { 
                video: true, 
                audio: { deviceId: micSelect.value ? { exact: micSelect.value } : undefined } 
            };
            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
            }).catch(err => alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + err));
        }

        // --- 3. –õ–û–ì–ò–ö–ê PEERJS (P2P) ---
        function initPeer() {
            // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞—á–Ω–æ–º—É –±—Ä–æ–∫–µ—Ä—É (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
            peer = new Peer(null, {
                debug: 2
            });

            peer.on('open', (id) => {
                document.getElementById('myId').value = id;
            });

            // –ö–æ–≥–¥–∞ –ö –ù–ê–ú –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è (–ß–∞—Ç)
            peer.on('connection', (connection) => {
                setupConnection(connection);
            });

            // –ö–æ–≥–¥–∞ –ù–ê–ú –∑–≤–æ–Ω—è—Ç (–í–∏–¥–µ–æ)
            peer.on('call', (call) => {
                call.answer(localStream); // –û—Ç–≤–µ—á–∞–µ–º —Å–≤–æ–∏–º –ø–æ—Ç–æ–∫–æ–º
                handleCall(call);
            });
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ö –î–†–£–ì–£
        function connectToPeer() {
            const remoteId = document.getElementById('remoteId').value;
            if(!remoteId) return alert("–í—Å—Ç–∞–≤—å ID –¥—Ä—É–≥–∞!");

            // 1. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (—á–∞—Ç)
            const connection = peer.connect(remoteId);
            setupConnection(connection);

            // 2. –ó–≤–æ–Ω–æ–∫ (–≤–∏–¥–µ–æ)
            const call = peer.call(remoteId, localStream);
            handleCall(call);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Ç–∞
        function setupConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                updateStatus(true);
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–π –Ω–∏–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                conn.send({ type: 'info', nick: myNick, avatar: myAvatarUrl });
            });

            conn.on('data', (data) => {
                if(data.type === 'message') {
                    addMessage(data.nick, data.avatar, data.text, false);
                } else if (data.type === 'info') {
                    // –ü–æ–ª—É—á–∏–ª–∏ –∏–Ω—Ñ–æ –æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ
                    addSystemMessage(`–ü–æ–¥–∫–ª—é—á–µ–Ω –∫: ${data.nick}`);
                }
            });
            
            conn.on('close', () => updateStatus(false));
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–≤–æ–Ω–∫–∞
        function handleCall(call) {
            currentCall = call;
            call.on('stream', (remoteStream) => {
                const video = document.getElementById('remoteVideo');
                video.srcObject = remoteStream;
            });
            call.on('close', () => {
                document.getElementById('remoteVideo').srcObject = null;
            });
        }

        // --- 4. –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê –ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ---
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value;
            if(!text || !conn) return;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ P2P
            conn.send({ type: 'message', nick: myNick, avatar: myAvatarUrl, text: text });
            addMessage(myNick, myAvatarUrl, text, true);
            input.value = '';
        }

        function addMessage(nick, avatar, text, isMine) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${isMine ? 'mine' : ''}`;
            div.innerHTML = `
                <img src="${avatar}">
                <div class="msg-content">
                    <div style="font-size:10px; opacity:0.7; margin-bottom:2px;">${nick}</div>
                    ${text}
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
        
        function addSystemMessage(text) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.style.textAlign = 'center';
            div.style.fontSize = '12px';
            div.style.color = '#888';
            div.style.margin = '10px 0';
            div.innerText = text;
            box.appendChild(div);
        }

        // --- 5. –§–ò–®–ö–ò: –î–ï–ú–ö–ê, –ú–£–¢, –ö–ê–ú–ï–†–ê ---
        function toggleMic() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('btnMic').innerText = track.enabled ? "üé§ –í—ã–∫–ª –ú–∏–∫—Ä–æ" : "üé§ –í–∫–ª –ú–∏–∫—Ä–æ";
            document.getElementById('btnMic').style.background = track.enabled ? "#444" : "#dc3545";
        }

        function toggleCam() {
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('btnCam').innerText = track.enabled ? "üì∑ –í—ã–∫–ª –ö–∞–º–µ—Ä—É" : "üì∑ –í–∫–ª –ö–∞–º–µ—Ä—É";
        }

        function shareScreen() {
            navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }).then(screenStream => {
                // –ó–∞–º–µ–Ω–∞ —Ç—Ä–µ–∫–∞ —É —Ç–µ–∫—É—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
                const screenTrack = screenStream.getVideoTracks()[0];
                const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                sender.replaceTrack(screenTrack);

                screenTrack.onended = () => {
                    sender.replaceTrack(localStream.getVideoTracks()[0]);
                };
            });
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(conn) conn.close();
            location.reload(); // –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ
        }

        function copyId() {
            const id = document.getElementById('myId');
            id.select();
            document.execCommand('copy');
            alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
        }

        function updateStatus(isConnected) {
            const el = document.getElementById('connectionStatus');
            el.style.display = 'inline-block';
            if(isConnected) {
                el.className = 'status-badge status-ok';
                el.innerText = "–ü–û–î–ö–õ–Æ–ß–ï–ù–û";
            } else {
                el.className = 'status-badge status-wait';
                el.innerText = "–û–¢–ö–õ–Æ–ß–ï–ù–û";
            }
        }
    </script>
</body>
</html>